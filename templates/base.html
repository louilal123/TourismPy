<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Labor PH | Data Analytics</title>
   
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/image.png') }}">


    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://unpkg.com/split-type"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        accent: '#FF3E3E',
                        dark: {
                            900: '#0a0a0a',
                            800: '#1a1a1a',
                            700: '#2c2c2c',
                            600: '#3d3d3d'
                        },
                        light: {
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3'
                        },
                        muted: '#a3a3a3'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-light-100 text-dark-900 dark:bg-dark-900 dark:text-light-100 transition-colors">
   
   <!-- ============ -->
 <!-- Custom Cursor -->
 <div class="cursor"></div>
 <div class="cursor-follower"></div>
 
 <!-- Preloader -->
 <div id="preloader" class="fixed inset-0 bg-dark flex flex-col items-center justify-center z-50">
     <h1 class="text-3xl md:text-3xl font-bold text-light tracking-tighter">
         <span id="preloader-counter">0</span><span>%</span>
     </h1>
     <p class="mt-4 text-muted text-lg">Loading</p>
     <div class="w-48 h-0.5 bg-muted/30 mt-6 overflow-hidden">
         <div id="preloader-bar" class="h-full bg-accent" style="width: 0%"></div>
     </div>
 </div>

    {% include 'navbar.html' %}

   {% block content %}
   
   {% endblock %}

    {% include 'footer.html' %}

    {% block scripts %}
   <!-- Add this script at the end of your body -->
   <script src="../static/js/script.js"></script>
   <script>
    let islandChart, regionChart;

    async function fetchIslandData(year = 'all') {
        const response = await fetch(`/api/island-cases?year=${year}`);
        return await response.json();
    }

    async function fetchRegionData(island, region, year) {
        const response = await fetch(`/api/region-data?island=${island}&region=${region}&year=${year}`);
        return await response.json();
    }

    async function fetchRegionsByIsland(island) {
        const response = await fetch(`/api/regions?island=${island}`);
        return await response.json();
    }

    async function initChart() {
        const islandData = await fetchIslandData();
        createIslandChart(islandData);

        const yearFilter = document.getElementById('yearFilter');
        islandData.years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        });

        yearFilter.addEventListener('change', async () => {
            const filteredData = await fetchIslandData(yearFilter.value);
            updateIslandChart(filteredData);
        });
    }

    function createIslandChart(data) {
    const ctx = document.getElementById('islandChart').getContext('2d');
    islandChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.island_groups,
            datasets: [{
                data: data.cases,
                backgroundColor: ['#FF6384', '#36A2EB', '#4BC0C0'],
                borderColor: ['#FF6384', '#36A2EB', '#4BC0C0'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',  // Adjust legend position as needed
                    display: true
                },
                tooltip: {
                    callbacks: {
                        label: context => `${context.label}: ${context.raw.toLocaleString()} cases`
                    }
                }
            },
            cutoutPercentage: 60, // Adjust this to control the size of the center hole
        }
    });
}

    function updateIslandChart(data) {
        islandChart.data.labels = data.island_groups;
        islandChart.data.datasets[0].data = data.cases;
        islandChart.update();
    }

    function createRegionChart(groupedData) {
        const ctx = document.getElementById('regionChart').getContext('2d');

        const provinces = Object.keys(groupedData);
        const allYears = [...new Set(provinces.flatMap(p => Object.keys(groupedData[p])))].sort();

        const yearColors = {
            2020: '#FF6384',
            2021: '#36A2EB',
            2022: '#4BC0C0',
            2023: '#FFCD56',
        };

        // Handle the edge case for one entry (like NCR)
        const datasets = allYears.map(year => ({
            label: year,
            data: provinces.map(p => groupedData[p][year] || 0),
            borderColor: yearColors[year] || '#CCCCCC',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.1
        }));

        if (provinces.length === 1) {
            datasets[0].backgroundColor = '#36A2EB'; // Set a color for single entry
        }

        regionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: provinces,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => `${context.raw.toLocaleString()} cases`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value.toLocaleString()
                        }
                    },
                    x: {
                        stacked: false
                    }
                }
            }
        });
    }

    function updateRegionChart(groupedData) {
        const provinces = Object.keys(groupedData);
        const allYears = [...new Set(provinces.flatMap(p => Object.keys(groupedData[p])))].sort();

        const yearColors = {
            2020: '#FF6384',
            2021: '#36A2EB',
            2022: '#4BC0C0',
            2023: '#FFCD56',
        };

        const datasets = allYears.map(year => ({
            label: year,
            data: provinces.map(p => groupedData[p][year] || 0),
            borderColor: yearColors[year] || '#CCCCCC',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.1
        }));

        if (provinces.length === 1) {
            datasets[0].backgroundColor = '#36A2EB'; 
        }

        regionChart.data.labels = provinces;
        regionChart.data.datasets = datasets;
        regionChart.update();
    }

    async function loadRegionChart() {
        const island = document.getElementById('islandFilter').value;
        const region = document.getElementById('regionFilter').value;
        const year = document.querySelectorAll('#yearFilter')[1].value;
        const data = await fetchRegionData(island, region, year);

        if (!regionChart) {
            createRegionChart(data);
        } else {
            updateRegionChart(data);
        }
    }

    async function initRegionChartFilters() {
        const islandFilter = document.getElementById('islandFilter');
        const regionFilter = document.getElementById('regionFilter');
        const yearFilter = document.querySelectorAll('#yearFilter')[1];

        ['Luzon', 'Visayas', 'Mindanao'].forEach(island => {
            const option = document.createElement('option');
            option.value = island;
            option.textContent = island;
            islandFilter.appendChild(option);
        });

        islandFilter.addEventListener('change', async () => {
            const selectedIsland = islandFilter.value;
            const { regions } = await fetchRegionsByIsland(selectedIsland);

            regionFilter.innerHTML = '';
            regions.forEach((region, index) => {
                const opt = document.createElement('option');
                opt.value = region;
                opt.textContent = region;
                if (index === 0) opt.selected = true;
                regionFilter.appendChild(opt);
            });

            loadRegionChart();
        });

        regionFilter.addEventListener('change', loadRegionChart);
        yearFilter.addEventListener('change', loadRegionChart);

        islandFilter.value = 'Luzon';
        const { regions } = await fetchRegionsByIsland('Luzon');
        regions.forEach(region => {
            const opt = document.createElement('option');
            opt.value = region;
            opt.textContent = region;
            regionFilter.appendChild(opt);
        });

        const allYears = await fetchIslandData();
        allYears.years.forEach(year => {
            const opt = document.createElement('option');
            opt.value = year;
            opt.textContent = year;
            yearFilter.appendChild(opt);
        });

        loadRegionChart();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await initChart();
        await initRegionChartFilters();
    });
</script>
<script>
    let islandGroupYearChart;

async function fetchIslandGroupData(islandGroup = 'all', year = 'all') {
    const response = await fetch(`/api/estimated-cases-by-island-group?island_group=${islandGroup}&year=${year}`);
    return await response.json();
}

async function initIslandGroupYearChart() {
    const islandGroupData = await fetchIslandGroupData();
    createIslandGroupYearChart(islandGroupData);

    const yearFilter = document.getElementById('yearFilter');
    const islandGroupFilter = document.getElementById('islandGroupYearFilter');

    islandGroupFilter.addEventListener('change', async () => {
        const filteredData = await fetchIslandGroupData(islandGroupFilter.value, yearFilter.value);
        updateIslandGroupYearChart(filteredData);
    });

    yearFilter.addEventListener('change', async () => {
        const filteredData = await fetchIslandGroupData(islandGroupFilter.value, yearFilter.value);
        updateIslandGroupYearChart(filteredData);
    });
}

function createIslandGroupYearChart(data) {
    const ctx = document.getElementById('islandGroupYearChart').getContext('2d');

    const years = data.data.map(item => item.Year);
    const cases = data.data.map(item => item['Estimated Cases']);

    const colors = [
        '#FF6384', '#36A2EB', '#4BC0C0'
    ];
    // #FF6384', '#FF6384', '#4BC0C0
    // 2020: '#FF6384',
    //         2021: '#36A2EB',
    //         2022: '#4BC0C0',
    islandGroupYearChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: years,
            datasets: [{
                label: 'Estimated Cases',
                data: cases,
                backgroundColor: colors.slice(0, cases.length),
                borderColor: colors.slice(0, cases.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString()
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: context => `${context.raw.toLocaleString()} cases`,
                        title: context => `Year: ${context[0].label}`
                    },
                    backgroundColor: '#000',
                    titleFont: {
                        size: 16,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 14,
                    },
                    displayColors: false
                }
            }
        }
    });
}

function updateIslandGroupYearChart(data) {
    islandGroupYearChart.data.labels = data.data.map(item => item.Year);
    islandGroupYearChart.data.datasets[0].data = data.data.map(item => item['Estimated Cases']);
    islandGroupYearChart.update();
}

document.addEventListener('DOMContentLoaded', async () => {
    await initIslandGroupYearChart();
});

</script>

    <script>
    const themeToggle = document.getElementById('theme-toggle');
    const iconDark = document.getElementById('theme-icon-dark');
    const iconLight = document.getElementById('theme-icon-light');
    const root = document.documentElement;

    function loadTheme() {
    const storedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (storedTheme === 'dark' || (!storedTheme && systemPrefersDark)) {
        root.classList.add('dark');
        iconDark.classList.remove('hidden');
        iconLight.classList.add('hidden');
    } else {
        root.classList.remove('dark');
        iconDark.classList.add('hidden');
        iconLight.classList.remove('hidden');
    }
}


    // Toggle dark/light theme
    function toggleTheme() {
        const isDark = root.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        iconDark.classList.toggle('hidden', !isDark);
        iconLight.classList.toggle('hidden', isDark);
    }

    themeToggle.addEventListener('click', toggleTheme);

    // Initialize theme
    loadTheme();
</script>

      // Init on DOM load
 
       window.addEventListener('scroll', function() {
           const header = document.getElementById('main-header');
           const homeSection = document.getElementById('home');
           const homeSectionBottom = homeSection.offsetTop + homeSection.offsetHeight;
           
           if (window.scrollY > homeSectionBottom) {
               header.classList.remove('backdrop-blur-none');
               header.classList.add('backdrop-blur-sm', 'bg-white/80', 'dark:bg-dark-800/80');
           } else {
               header.classList.add('backdrop-blur-none');
               header.classList.remove('backdrop-blur-sm', 'bg-white/80', 'dark:bg-dark-800/80');
           }
       });
       </script>
   <script>
    // Initialize reveal animations
    document.addEventListener('DOMContentLoaded', () => {
        const revealElements = document.querySelectorAll('.reveal');
        
        const revealObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 });
        
        revealElements.forEach(element => {
            revealObserver.observe(element);
        });

        // Animate split characters
        const splitTextElements = document.querySelectorAll('.split-char');
        splitTextElements.forEach((char, index) => {
            setTimeout(() => {
                char.style.transform = 'translateY(0)';
                char.style.opacity = '1';
            }, index * 50);
        });
    });
</script>
    <script>
          // Mobile menu functionality
          const mobileMenuButton = document.getElementById('mobile-menu-button');
        const closeMenuButton = document.getElementById('close-menu-button');
        const mobileMenu = document.querySelector('.mobile-menu');
        const menuOverlay = document.querySelector('.menu-overlay');
        
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            menuOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        
        closeMenuButton.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            menuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        menuOverlay.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            menuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // Close menu when clicking on a link
        document.querySelectorAll('.mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
        });

    </script>
    {% endblock %}
    
</body>

</html>
